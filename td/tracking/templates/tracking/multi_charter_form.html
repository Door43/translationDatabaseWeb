{% extends "site_base.html" %}


{% load i18n %}
{% load bootstrap %}

{% block head_title %}Tracking | New Charter{% endblock head_title %}

{% block extra_style %}
	<style>
		form .form-group::after {
			content: '';
			display: block;
			clear: both;
		}
		.date-input {
			width: calc(33.33% - 3px);
			display: inline-block;
			float: left;
			margin-right: 3px;
		}
		.date-input:last-child {
			width: 33.33%;
			margin-right: 0;
		}
		.form-notice-container {
			padding: 1rem;
			margin-bottom: 2rem;
			background-color: rgba(0,0,0,0.075);
			border-radius: 5px;
		}
		.form-notice {
			font-weight: lighter;
			cursor: pointer;
		}
	</style>
{% endblock extra_style %}	

{% block body %}
	<div class="form-notice-container">
		<p class="form-notice">Note: Searching for a languagefor the first time may take a while.</p>
		<p class="form-notice">Note: If your language doesn't show up on the search, it's because that language is not in our database yet. Email <a>help@door43.org</a> for more info.</p>
	</div>
	<form action="" method="POST" class="form">
		{% csrf_token %}
		{{ formset.management_form }}
		<div class="form-list">
			{% for form in formset %}
				<div class="row form-instance">
					<div class="col-md-6">
						<div class="panel panel-default">
							{% if forloop.first %}
								<div class="panel-heading">
									<h2 class="panel-title">New Translation Project Charter</h2>
								</div>
							{% endif %}
							<div class="panel-body">
								{{ form | bootstrap}}
								<a href="" class="remove-form-link" style="margin-top: -2rem; font-weight: lighter;">Remove</a>
							</div>
						</div>
					</div>
				</div>
			{% endfor %}
		</div>

		<a href="" class="add-form-link" style="display: block; margin: 1rem 0; font-weight: lighter;">More Charter</a>

		<div class="row">
			<div class="col-md-6">
				<button type="submit" class="btn btn-primary btn-block">
					{% if form.errors %}Try again{% else %}Add Project(s){% endif %}
				</button>
			</div>
		</div>
	</form>

{% endblock body%}

{% block custom_bottom_script %}
	<script>

		$(document).ready(function() {
			// Initial script
			//
			var form = $('.form-instance:first').clone();
			var formNumber = parseInt($('.form-instance:last').find('.panel-body').children().eq(0).prop('id').substring(8, 9));
			console.log('formNumber', formNumber);
			$('.language-selector-marked').languageSelector();

			// Event listeners
            // 
            $('.add-form-link').on('click', function(e) {
                e.preventDefault();
                addForm();
            });
            $('form').on('click', '.remove-form-link', function(e) {
                e.preventDefault();
                removeForm(this);
            });

            // Function defs
            // 
			function addForm() {
				// 
				formNumber++;
				$('#form-number').val(formNumber);
				console.log('adding', formNumber);
				// 
				var clone = updateIndex(form.clone(), formNumber);
				clone.find('.language-selector-marked').languageSelector();
				clone.appendTo('.form-list');
				// 
				var total = $('#id_form-TOTAL_FORMS');
				total.val(parseInt(total.val()) + 1);
				// 
			}
			function removeForm(el) {
				// Remove the form container element
				$(el).parents('.form-instance').detach();
				// Update form numbering system
				renumberForms($('.form-instance'));
				formNumber--;
				var total = $('#id_form-TOTAL_FORMS');
				total.val(parseInt(total.val()) - 1);
			}
			function updateIndex(form, number) {
				var currentId = new RegExp('form' + '-(\\d+)-');
				var replacement = 'form-' + number + '-';
				form.find('input').each(function(index, el) {
					$(el).prop('id', $(el).prop('id').replace(currentId, replacement));
					$(el).prop('name', $(el).prop('name').replace(currentId, replacement));
				});
				form.find('select').each(function(index, el) {
					$(el).prop('id', $(el).prop('id').replace(currentId, replacement));
					$(el).prop('name', $(el).prop('name').replace(currentId, replacement));
				});
				form.find('label').each(function(index, el) {
					$(el).prop('for', $(el).prop('for').replace(currentId, replacement));
				});
				return form;
			}
			function renumberForms(forms) {
				$(forms).each(function(index, form) {
					form = updateIndex($(form), index);
				});
			}

		});
	</script>
{% endblock custom_bottom_script %}
